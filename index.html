<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Relay System Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Smart Relay System Dashboard</h1>
    <p>Real-Time Monitoring of Relays, RFID Tags, Noise & Lightning</p>
  </header>

  <main>
    <section class="status-cards">
      <div class="card" id="relay1Card">
        <h2>Relay 1</h2>
        <p id="relay1State">Loading...</p>
      </div>
      <div class="card" id="relay2Card">
        <h2>Relay 2</h2>
        <p id="relay2State">Loading...</p>
      </div>
      <div class="card" id="lockCard">
        <h2>Lock Relay</h2>
        <p id="lockState">Loading...</p>
      </div>
      <div class="card" id="noiseCard">
        <h2>Noise Level</h2>
        <p id="noiseLevel">Loading...</p>
      </div>
      <div class="card" id="lightningCard">
        <h2>Lightning</h2>
        <p id="lightningState">Loading...</p>
      </div>
    </section>

    <section class="events-table">
      <h2>Event Logs</h2>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>RFID Tag</th>
            <th>Action</th>
            <th>Relay 1</th>
            <th>Relay 2</th>
            <th>Lock Relay</th>
            <th>Noise</th>
            <th>Lightning</th>
          </tr>
        </thead>
        <tbody id="eventsBody">
          <tr><td colspan="8">Loading events...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>Â© 2025 SPS PROJECT HUB</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDoQ0KrB6B2FHHaz4udbX9q5eURmrnqROI",
      authDomain: "dtms-6485f.firebaseapp.com",
      databaseURL: "https://dtms-6485f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtms-6485f",
      storageBucket: "dtms-6485f.appspot.com",
      messagingSenderId: "113375753382",
      appId: "1:113375753382:web:98046f838c994ae41eb067"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const eventsRef = ref(db, 'events');

    onValue(eventsRef, (snapshot) => {
      const data = snapshot.val();
      const eventsBody = document.getElementById('eventsBody');
      eventsBody.innerHTML = '';

      if (!data) {
        eventsBody.innerHTML = '<tr><td colspan="8">No events yet.</td></tr>';
        return;
      }

      const keys = Object.keys(data);
      keys.sort((a,b) => data[a].timestamp - data[b].timestamp);

      keys.forEach(key => {
        const event = data[key];

        // Update cards with last state
        document.getElementById('relay1State').textContent = event.relay1;
        document.getElementById('relay2State').textContent = event.relay2;
        document.getElementById('lockState').textContent = event.lock_relay;
        document.getElementById('noiseLevel').textContent = event.noise_floor;
        document.getElementById('lightningState').textContent = event.lightning;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(event.timestamp).toLocaleString()}</td>
          <td>${event.last_rfid_tag}</td>
          <td>${event.action}</td>
          <td>${event.relay1}</td>
          <td>${event.relay2}</td>
          <td>${event.lock_relay}</td>
          <td>${event.noise_floor}</td>
          <td>${event.lightning}</td>
        `;
        eventsBody.appendChild(row);
      });
    });
  </script>
</body>
</html>
